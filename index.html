<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Proveedores por Producto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-xl md:text-2xl font-bold text-gray-900">ARTICULOS-PROVEEDOR</h1>
        </header>

        <div id="status-section" class="mb-6 text-center">
             <p id="file-status" class="text-center text-sm font-medium h-5 mt-3"></p>
        </div>

        <!-- Búsqueda de Productos -->
        <div id="search-section" class="hidden mb-6">
            <h2 class="text-base font-semibold text-gray-700 mb-4">Introduce Articulo</h2>
            <div>
                <div class="flex items-center gap-2">
                    <input type="search" inputmode="text" id="search-input" placeholder="Escribe una descripción..." class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow text-sm">
                </div>
            </div>
        </div>

        <div id="result-section" class="mt-6 p-6 bg-gray-50 rounded-lg min-h-[100px] flex items-center justify-center">
             <p id="result-text" class="text-gray-500 text-center text-sm">Aquí se mostrarán los productos encontrados.</p>
        </div>

        <div id="provider-section" class="mt-4">
            <!-- Los proveedores del producto seleccionado se mostrarán aquí -->
        </div>

    </div>

    <script>
        // --- Variables Globales ---
        let productData = [];
        let currentMatches = {};

        // --- Elementos del DOM ---
        const fileStatus = document.getElementById('file-status');
        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('search-input');
        const resultSection = document.getElementById('result-section');
        const resultText = document.getElementById('result-text');
        const providerSection = document.getElementById('provider-section');

        // --- Lógica de Carga de Datos ---
        document.addEventListener('DOMContentLoaded', loadProductData);

        function loadProductData() {
            searchSection.classList.remove('hidden');
            searchInput.focus();
            fileStatus.textContent = 'Cargando base de datos...';
            fileStatus.className = 'text-center text-sm text-gray-500 font-medium h-5 mt-3';

            fetch('PRODUCTOS-PROVEEDORES.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error al cargar el archivo: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(csvData => {
                    try {
                        const lines = csvData.replace(/\r\n/g, '\n').replace(/^\uFEFF/, '').split('\n');
                        const dataLines = lines.slice(1).filter(line => line.trim() !== '');

                        productData = dataLines.map(line => {
                            const values = line.split(';');
                            if (values.length >= 2) {
                                const provider = values[0].trim();
                                const description = values[1].trim();
                                if (provider && description) {
                                    return { description, provider };
                                }
                            }
                            return null;
                        }).filter(p => p);

                        if (productData.length > 0) {
                            fileStatus.textContent = `¡Éxito! Se cargaron ${productData.length} registros.`;
                            fileStatus.className = 'text-center text-sm text-green-600 font-medium h-5 mt-3';
                        } else {
                            fileStatus.textContent = 'Error: No se encontraron datos de productos válidos en el archivo.';
                            fileStatus.className = 'text-center text-sm text-red-600 font-medium h-5 mt-3';
                        }

                    } catch (error) {
                        fileStatus.textContent = 'Ocurrió un error crítico al procesar los datos.';
                        fileStatus.className = 'text-center text-sm text-red-600 font-medium h-5 mt-3';
                        console.error("Error detallado:", error);
                    }
                })
                .catch(error => {
                    fileStatus.textContent = 'No se pudo cargar el archivo CSV.';
                    fileStatus.className = 'text-center text-sm text-red-600 font-medium h-5 mt-3';
                    console.error('Error en fetch:', error);
                });
        }

        // --- Lógica de Búsqueda ---
        function handleSearch() {
            const rawQuery = searchInput.value.trim();
            const lowerCaseQuery = rawQuery.toLowerCase();
            
            providerSection.innerHTML = ''; // Limpiar la sección de proveedores al buscar de nuevo

            if (productData.length === 0 && rawQuery.length > 0) {
                resultText.innerHTML = `<p class="text-red-500 text-center text-sm">La base de datos no se cargó. La búsqueda no puede funcionar.</p>`;
                return;
            }

            if (rawQuery === '') {
                resultText.innerHTML = `<p class="text-gray-500 text-center text-sm">Aquí se mostrarán los productos encontrados.</p>`;
                resultSection.className = 'mt-6 p-6 bg-gray-50 rounded-lg min-h-[100px] flex items-center justify-center';
                return;
            }

            if (lowerCaseQuery.length < 3) {
                resultText.innerHTML = `<p class="text-gray-500 text-center text-sm">Escribe al menos 3 letras para empezar a buscar...</p>`;
                resultSection.className = 'mt-6 p-6 bg-yellow-50 border border-yellow-200 rounded-lg';
                return;
            }

            const matches = productData.filter(p => 
                p.description.toLowerCase().includes(lowerCaseQuery)
            );
            
            if (matches.length > 0) {
                displayResults(matches, rawQuery);
            } else {
                resultText.innerHTML = `
                    <div class="text-center">
                        <span class="block text-xs text-gray-500">No se encontraron productos para:</span>
                        <strong class="block text-lg text-red-700 mt-1">${searchInput.value.trim()}</strong>
                    </div>`;
                resultSection.className = 'mt-6 p-6 bg-red-50 border border-red-200 rounded-lg';
            }
        }

        function displayResults(matches, query) {
            const productsGrouped = matches.reduce((acc, product) => {
                const key = product.description;
                if (!acc[key]) {
                    acc[key] = {
                        description: product.description,
                        providers: []
                    };
                }
                if (!acc[key].providers.includes(product.provider)) {
                    acc[key].providers.push(product.provider);
                }
                return acc;
            }, {});

            currentMatches = productsGrouped;
            const productList = Object.values(productsGrouped);

            let resultsHtml = `
                <div class="text-left w-full">
                    <p class="font-semibold mb-3 text-gray-700">Se encontraron ${productList.length} producto(s) para "<span class="font-bold">${query}</span>":</p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <ul id="product-list" class="space-y-2">`;
            
            productList.forEach((product, index) => {
                resultsHtml += `
                    <li id="product-item-${index}" onclick="showProviders('${product.description.replace(/'/g, "\\'")}', ${index})" class="p-3 border border-gray-200 rounded-lg bg-white cursor-pointer hover:bg-gray-50 hover:border-blue-500 transition-all duration-150">
                        <strong class="block text-sm text-gray-800 pointer-events-none">${product.description}</strong>
                    </li>`;
            });

            resultsHtml += `</ul></div></div>`;
            resultText.innerHTML = resultsHtml;
            resultSection.className = 'mt-6 p-4 bg-gray-50 rounded-lg';
        }

        function showProviders(description, selectedIndex) {
            const productListItems = document.querySelectorAll('#product-list li');
            productListItems.forEach((item, index) => {
                item.classList.remove('bg-blue-100', 'border-blue-500');
                item.classList.add('bg-white', 'border-gray-200');
                if (index === selectedIndex) {
                    item.classList.add('bg-blue-100', 'border-blue-500');
                    item.classList.remove('bg-white', 'border-gray-200');
                }
            });

            const product = currentMatches[description];
            if (!product) return;

            let providerHtml = `
                <h3 class="text-base font-semibold text-gray-800 mb-3 mt-4">Proveedores para: <span class="font-medium text-blue-600">${product.description}</span></h3>
                <div class="flex flex-wrap justify-center gap-2 p-4 bg-white border-2 border-blue-200 rounded-lg">
            `;
            
            if (product.providers.length > 0) {
                providerHtml += product.providers.map(provider => `
                    <span class="bg-blue-100 text-blue-800 text-lg font-medium px-3 py-1 rounded-full">${provider}</span>
                `).join('');
            } else {
                providerHtml += `<p class="text-gray-500">No se encontraron proveedores para este producto.</p>`;
            }

            providerHtml += `</div>`;
            providerSection.innerHTML = providerHtml;
        }

        // --- Asignación de Eventos Iniciales ---
        searchInput.addEventListener('input', handleSearch);
    </script>
</body>
</html>